filter {
  # Azure Activity Logs Parser
  # Parses Azure Activity Logs (Control Plane operations)
  # Related: GitHub Issue #232 - Cloud Infrastructure Logs Integration
  
  if ([event][dataset] == "azure.activitylogs") {
    
    # Azure Activity Logs are in JSON format
    # Format: https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/activity-log-schema
    
    json {
      id => "json_azure_activity_parse"
      source => "message"
      target => "azure.activity"
    }
    
    # Extract timestamp
    if [azure.activity][time] {
      date {
        id => "date_azure_activity_timestamp"
        match => [ "[azure.activity][time]", "ISO8601" ]
        target => "@timestamp"
      }
    }
    
    # Map Azure Activity fields to ECS
    if [azure.activity][caller] {
      mutate {
        id => "mutate_azure_activity_user"
        add_field => { 
          "[user][name]" => "%{[azure.activity][caller]}"
          "[user][id]" => "%{[azure.activity][caller]}"
        }
      }
    }
    
    if [azure.activity][operationName] {
      mutate {
        id => "mutate_azure_activity_operation"
        add_field => { "[event][action]" => "%{[azure.activity][operationName]}" }
      }
    }
    
    if [azure.activity][callerIpAddress] {
      mutate {
        id => "mutate_azure_activity_source_ip"
        add_field => { "[source][ip]" => "%{[azure.activity][callerIpAddress]}" }
      }
    }
    
    if [azure.activity][resourceId] {
      mutate {
        id => "mutate_azure_activity_resource"
        add_field => { "[cloud][resource][id]" => "%{[azure.activity][resourceId]}" }
      }
    }
    
    if [azure.activity][subscriptionId] {
      mutate {
        id => "mutate_azure_activity_subscription"
        add_field => { "[cloud][account][id]" => "%{[azure.activity][subscriptionId]}" }
      }
    }
    
    if [azure.activity][resourceGroupName] {
      mutate {
        id => "mutate_azure_activity_resource_group"
        add_field => { "[cloud][resource][group]" => "%{[azure.activity][resourceGroupName]}" }
      }
    }
    
    if [azure.activity][level] {
      mutate {
        id => "mutate_azure_activity_level"
        add_field => { "[log][level]" => "%{[azure.activity][level]}" }
      }
    }
    
    # Set event outcome based on status
    if [azure.activity][status] {
      if [azure.activity][status][value] == "Succeeded" or [azure.activity][status][value] == "Success" {
        mutate {
          id => "mutate_azure_activity_success"
          add_field => { "[event][outcome]" => "success" }
        }
      } else if [azure.activity][status][value] == "Failed" or [azure.activity][status][value] == "Failure" {
        mutate {
          id => "mutate_azure_activity_failure"
          add_field => { 
            "[event][outcome]" => "failure"
            "[event][type]" => "error"
          }
        }
      } else if [azure.activity][status][value] =~ /^(Started|Accepted)$/ {
        mutate {
          id => "mutate_azure_activity_in_progress"
          add_field => { "[event][outcome]" => "unknown" }
        }
      }
    }
    
    # Add cloud metadata
    mutate {
      id => "mutate_azure_activity_cloud_metadata"
      add_field => {
        "[cloud][provider]" => "azure"
        "[cloud][service][name]" => "activity_logs"
        "[event][kind]" => "event"
        "[event][category]" => "iam"
      }
    }
    
    # Classify operation categories
    if [event.action] {
      # Write operations (create, update, delete)
      if [event.action] =~ /(?i)(create|write|update|put|post|patch)/ {
        mutate {
          id => "mutate_azure_activity_write"
          add_field => { "[event][type]" => "change" }
        }
      }
      
      # Delete operations
      if [event.action] =~ /(?i)(delete|remove)/ {
        mutate {
          id => "mutate_azure_activity_delete"
          add_field => { "[event][type]" => "deletion" }
          add_tag => ["resource_deletion"]
        }
      }
      
      # Read operations
      if [event.action] =~ /(?i)(read|get|list|query)/ {
        mutate {
          id => "mutate_azure_activity_read"
          add_field => { "[event][type]" => "access" }
        }
      }
    }
    
    # Detect high-risk operations
    if [event.action] =~ /(?i)(delete|remove|destroy|terminate|stop|shutdown)/ {
      mutate {
        id => "mutate_azure_activity_high_risk"
        add_tag => ["high_risk_action"]
      }
    }
    
    # Detect security-related operations
    if [event.action] =~ /(?i)(role|permission|policy|firewall|security|access|authentication|authorization)/ {
      mutate {
        id => "mutate_azure_activity_security"
        add_tag => ["security_operation"]
      }
    }
    
    # Detect failed operations
    if [event.outcome] == "failure" {
      mutate {
        id => "mutate_azure_activity_failed"
        add_tag => ["failed_operation"]
      }
      
      # Check for access denied
      if [azure.activity][status][value] =~ /(?i)(denied|forbidden|unauthorized)/ or 
         [azure.activity][status][localizedValue] =~ /(?i)(denied|forbidden|unauthorized)/ {
        mutate {
          id => "mutate_azure_activity_access_denied"
          add_tag => ["unauthorized_access_attempt"]
        }
      }
    }
    
    # Detect administrative operations
    if [event.action] =~ /(?i)(admin|administrator|subscription|tenant|management)/ {
      mutate {
        id => "mutate_azure_activity_admin"
        add_tag => ["administrative_action"]
      }
    }
    
    # Detect network security group changes
    if [event.action] =~ /(?i)networkSecurityGroups/ {
      mutate {
        id => "mutate_azure_activity_nsg_change"
        add_tag => ["nsg_modification"]
      }
    }
    
    # Detect virtual machine operations
    if [event.action] =~ /(?i)virtualMachines/ {
      mutate {
        id => "mutate_azure_activity_vm_operation"
        add_tag => ["vm_operation"]
      }
    }
    
    # Detect storage account operations
    if [event.action] =~ /(?i)storageAccounts/ {
      mutate {
        id => "mutate_azure_activity_storage_operation"
        add_tag => ["storage_operation"]
      }
    }
    
    # Detect key vault operations
    if [event.action] =~ /(?i)vaults/ {
      mutate {
        id => "mutate_azure_activity_keyvault_operation"
        add_tag => ["keyvault_operation", "sensitive_resource"]
      }
    }
    
    # Clean up
    mutate {
      id => "mutate_azure_activity_cleanup"
      remove_field => ["message"]
    }
    
    # Note: GeoIP enrichment for source.ip will be handled by Malcolm's
    # existing 11_lookups.conf filter
    
  } # end if azure.activitylogs

} # end filter
