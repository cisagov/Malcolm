filter {
  # AWS CloudTrail Logs Parser
  # Parses AWS API activity logs from CloudTrail
  # Related: GitHub Issue #232 - Cloud Infrastructure Logs Integration
  
  if ([event][dataset] == "aws.cloudtrail") {
    
    # CloudTrail logs are JSON format
    json {
      id => "json_cloudtrail_parse"
      source => "message"
      target => "cloudtrail"
      skip_on_invalid_json => true
      tag_on_failure => ["_jsonparsefailure_cloudtrail"]
    }
    
    if ([cloudtrail]) {
      
      # Extract key fields to ECS format
      mutate {
        id => "mutate_cloudtrail_ecs_fields"
        add_field => {
          "[cloud][provider]" => "aws"
          "[cloud][service][name]" => "cloudtrail"
          "[event][action]" => "%{[cloudtrail][eventName]}"
          "[event][kind]" => "event"
          "[event][category]" => "iam"
          "[event][type]" => "access"
        }
      }
      
      # Extract timestamp
      if ([cloudtrail][eventTime]) {
        date {
          id => "date_cloudtrail_eventtime"
          match => [ "[cloudtrail][eventTime]", "ISO8601" ]
          target => "@timestamp"
        }
      }
      
      # Extract user information
      if ([cloudtrail][userIdentity][userName]) {
        mutate {
          id => "mutate_cloudtrail_username"
          add_field => { "[user][name]" => "%{[cloudtrail][userIdentity][userName]}" }
        }
      }
      
      if ([cloudtrail][userIdentity][type]) {
        mutate {
          id => "mutate_cloudtrail_user_type"
          add_field => { "[user][type]" => "%{[cloudtrail][userIdentity][type]}" }
        }
      }
      
      # Extract source IP
      if ([cloudtrail][sourceIPAddress]) {
        mutate {
          id => "mutate_cloudtrail_source_ip"
          add_field => { "[source][ip]" => "%{[cloudtrail][sourceIPAddress]}" }
        }
      }
      
      # Extract AWS region
      if ([cloudtrail][awsRegion]) {
        mutate {
          id => "mutate_cloudtrail_region"
          add_field => { "[cloud][region]" => "%{[cloudtrail][awsRegion]}" }
        }
      }
      
      # Extract account ID
      if ([cloudtrail][userIdentity][accountId]) {
        mutate {
          id => "mutate_cloudtrail_account_id"
          add_field => { "[cloud][account][id]" => "%{[cloudtrail][userIdentity][accountId]}" }
        }
      }
      
      # Set event outcome based on error code
      if ([cloudtrail][errorCode]) {
        mutate {
          id => "mutate_cloudtrail_error_outcome"
          add_field => {
            "[event][outcome]" => "failure"
            "[error][code]" => "%{[cloudtrail][errorCode]}"
          }
        }
        
        # Tag unauthorized access attempts
        if [cloudtrail][errorCode] == "AccessDenied" or [cloudtrail][errorCode] == "UnauthorizedOperation" {
          mutate {
            id => "mutate_cloudtrail_unauthorized"
            add_tag => ["unauthorized_access_attempt"]
          }
        }
      } else {
        mutate {
          id => "mutate_cloudtrail_success_outcome"
          add_field => { "[event][outcome]" => "success" }
        }
      }
      
      # Classify high-risk actions
      if [event][action] in ["DeleteBucket", "DeleteDBInstance", "TerminateInstances", "DeleteUser", "DeleteRole", "PutBucketPolicy", "CreateAccessKey", "DeleteAccessKey"] {
        mutate {
          id => "mutate_cloudtrail_high_risk"
          add_tag => ["high_risk_action"]
        }
      }
      
      # Detect root account usage
      if ([cloudtrail][userIdentity][type] == "Root") {
        mutate {
          id => "mutate_cloudtrail_root_usage"
          add_tag => ["root_account_usage"]
        }
      }
      
      # Detect console login events
      if ([event][action] == "ConsoleLogin") {
        mutate {
          id => "mutate_cloudtrail_console_login"
          add_field => { "[event][type]" => "authentication" }
        }
        
        if ([cloudtrail][responseElements][ConsoleLogin] == "Failure") {
          mutate {
            id => "mutate_cloudtrail_failed_login"
            add_tag => ["failed_authentication"]
          }
        }
      }
      
      # Clean up temporary fields
      mutate {
        id => "mutate_cloudtrail_cleanup"
        remove_field => ["message"]
      }
      
      # Note: GeoIP enrichment for source.ip will be handled by Malcolm's
      # existing 11_lookups.conf filter
      
    } # end if cloudtrail
    
  } # end if aws.cloudtrail

} # end filter
