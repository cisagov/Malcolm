# <a name="CustomRulesAndScripts"></a>Custom Rules, Scripts and Plugins

* [Arkime](#Arkime)
* [Suricata](#Suricata)
* [Zeek](#Zeek)
* [YARA](#YARA)
* [NetBox Plugins](#NetBox)
* [Logstash Output Pipelines](#Logstash)
* [Other Customizations](#Other)

Much of Malcolm's behavior can be adjusted through [environment variable files](malcolm-config.md#MalcolmConfigEnvVars). However, some components allow further customization through the use of custom scripts, configuration files, and rules.

## <a name="Arkime"></a>Arkime

### Rules

[Arkime rules](https://arkime.com/rulesformat) "allow you to specify actions to perform when criteria are met with certain fields or state."

Arkime rules files (with the `*.yml` or `*.yaml` extension) may be placed in the `./arkime/rules/` subdirectory in the Malcolm installation directory. These new rules files can applied by restarting Malcolm, or this can be done manually without completely restarting Malcolm by running the following command from the Malcolm installation directory:

```
./scripts/restart -s arkime arkime-live
```

Malcolm comes with [a few Arkime rules]({{ site.github.repository_url }}/blob/{{ site.github.build_revision }}/arkime/rules/) included by default. More sample Arkime rules can be found on the [Arkime web site](https://arkime.com/rules).

### Lua Plugin

Arkime's [Lua plugin](https://arkime.com/settings#lua) allows sessions to be modified via simple Lua scripts. See the [Arkime Lua plugin documentation](https://github.com/arkime/arkime/tree/main/capture/plugins/lua) for more information and [example scripts](https://github.com/arkime/arkime/tree/main/capture/plugins/lua/samples).

Lua files for the Arkime Lua plugin (with the `*.lua` extension) may be placed in the `./arkime/lua/` subdirectory in the Malcolm installation directory. These new scripts can applied by restarting Malcolm, or this can be done manually without completely restarting Malcolm by running the following command from the Malcolm installation directory:

```
./scripts/restart -s arkime arkime-live
```

## <a name="Suricata"></a>Suricata

### Rules

In addition to the [default Suricata ruleset](https://github.com/OISF/suricata/tree/master/rules) and [Emerging Threads Open ruleset](https://rules.emergingthreats.net/open/), users may provide custom rules files for use by Suricata in Malcolm.

Suricata rules files (with the `*.rules` extension) may be placed in the `./suricata/rules/` subdirectory in the Malcolm installation directory. These new rules files will be picked up immediately for subsequent [PCAP upload](upload.md#Upload), and for [live analysis](live-analysis.md#LocalPCAP) will be applied by restarting Malcolm. This can also be done manually without interrupting the Suricata processes by running the following commands from the Malcolm installation directory.

First, for the `suricata-live` container:

```bash
$ docker compose exec -u $(id -u) suricata-live bash -c 'suricata_config_populate.py --suricata /usr/bin/suricata-offline && kill -USR2 $(pidof suricata)'
```

Then, for the `suricata` container:

```bash
$ docker compose exec -u $(id -u) suricata bash -c 'suricata_config_populate.py --suricata /usr/bin/suricata-offline && kill -USR2 $(pidof suricata-offline)'
```

Alternately, both Suricata services could be completely restarted with `./scripts/restart -s suricata suricata-live`.

For [Kubernetes deployments of Malcolm](kubernetes.md#Kubernetes), recreating the `suricata-offline-custom-rules-volume` and `suricata-live-custom-rules-volume` configMaps used by the [`suricata`]({{ site.github.repository_url }}/blob/{{ site.github.build_revision }}/kubernetes/11-suricata.yml) and [`suricata-live`]({{ site.github.repository_url }}/blob/{{ site.github.build_revision }}/kubernetes/22-suricata-live.yml) containers, respectively, and restarting those containers, will cause changes to custom rules files to be applied.

If the `SURICATA_CUSTOM_RULES_ONLY` [environment variable](malcolm-config.md#MalcolmConfigEnvVars) is set to `true`, Malcolm will bypass the default Suricata rulesets and use only the user-defined rules.

### Configuration

Suricata uses the [YAML format for configuration](https://docs.suricata.io/en/latest/configuration/suricata-yaml.html), and the main `suricata.yaml` file is generated by Malcolm [dynamically at runtime]({{ site.github.repository_url }}/blob/{{ site.github.build_revision }}/shared/bin/suricata_config_populate.py).

The contents of the `suricata.yaml` file can be adjusted via [environment variables](malcolm-config.md#MalcolmConfigEnvVars) found in [`suricata.env`]({{ site.github.repository_url }}/blob/{{ site.github.build_revision }}/config/suricata.env.example).

For more control of the Suricata configuration, Suricata allows other configuration YAML files to be [included](https://docs.suricata.io/en/latest/configuration/includes.html), allowing the configuration to be broken into multiple files.

Malcolm users may place additional Suricata configuration files (with the `.yaml` file extension) in the `./suricata/include-configs/` subdirectory in the Malcolm installation directory. When Malcolm creates the `suricata.yaml` file these additional files will be added at the end in an `include:` section.

To apply new `.yaml` files immediately without restarting Malcolm's Suricata containers, users may run the following commands from the Malcolm installation directory:

```
docker compose exec suricata /usr/local/bin/docker_entrypoint.sh true
```

```
docker compose exec suricata-live /usr/local/bin/docker_entrypoint.sh true
```

```
docker compose exec suricata-live supervisorctl restart live-suricata
```

## <a name="Zeek"></a>Zeek

Some aspects of Malcolm's instance of Zeek's [local site policy]({{ site.github.repository_url }}/blob/{{ site.github.build_revision }}/zeek/config/local.zeek) can be adjusted via [environment variables](malcolm-config.md#MalcolmConfigEnvVars) found in [`zeek.env`]({{ site.github.repository_url }}/blob/{{ site.github.build_revision }}/config/zeek.env.example).

For more control of Zeek's behavior, Malcolm's users may place Zeek files in the `./zeek/custom/` subdirectory in the Malcolm installation directory. The organization of this directory is left entirely up to the user: in other words, users placing files there will also need to create a `__load__.zeek` file there to [tell Zeek](https://docs.zeek.org/en/master/quickstart.html#telling-zeek-which-scripts-to-load) what to load from that directory.

These new files should be picked up immediately for subsequent [PCAP upload](upload.md#Upload), and for [live analysis](live-analysis.md#LocalPCAP) they will take effect upon restarting Malcolm, or without restarting Malcolm by running the following command from the Malcolm installation directory:

```
docker compose exec zeek-live supervisorctl restart live-zeek
```

## <a name="YARA"></a>YARA

[Custom rules](https://yara.readthedocs.io/en/stable/writingrules.html) files for [YARA](https://github.com/VirusTotal/yara) (with either the `*.yara` or `*.yar` file extension) may be placed in the `./yara/rules/` subdirectory in the Malcolm installation directory.

New rules files will take effect by either restarting Malcolm (specifically the `file-monitor` container) or when the automatic rule update runs (if automatic rule updates are enabled). This can also be done manually without restarting Malcolm by running the following commands from the Malcolm installation directory:

```
docker compose exec file-monitor /usr/local/bin/yara_rules_setup.sh
```

```
docker compose exec file-monitor supervisorctl restart yara
```

If the `EXTRACTED_FILE_YARA_CUSTOM_ONLY` [environment variable](malcolm-config.md#MalcolmConfigEnvVars) is set to `true`, Malcolm will bypass the default Yara rulesets ([Neo23x0/signature-base](https://github.com/Neo23x0/signature-base), [reversinglabs/reversinglabs-yara-rules](https://github.com/reversinglabs/reversinglabs-yara-rules), and [bartblaze/Yara-rules](https://github.com/bartblaze/Yara-rules)) and use only user-defined rules in `./yara/rules`.

## <a name="NetBox"></a>NetBox Plugins

NetBox's functionality can be extended with plugins that can provide "[new data models, integrations, and more](https://netboxlabs.com/netbox-plugins/)" (see also the [NetBox Wiki](https://github.com/netbox-community/netbox/wiki/Plugins)).

When Malcolm's NetBox container [starts up]({{ site.github.repository_url }}/blob/{{ site.github.build_revision }}/netbox/scripts/netbox_install_plugins.py), it installs (using [pip](https://packaging.python.org/en/latest/guides/tool-recommendations/#installing-packages)) any NetBox plugins that have [cloned](https://docs.github.com/en/repositories/creating-and-managing-repositories/cloning-a-repository) or [downloaded and extracted](https://docs.github.com/en/repositories/working-with-files/using-files/downloading-source-code-archives) into subdirectories in `./netbox/custom-plugins/` in the Malcolm installation directory. In instances where Malcolm is being run in an offline/airgapped configuration, the plugins' additional dependencies must also be present under `./netbox/custom-plugins/requirements/`, where they will be automatically installed first.

The following warning is quoted from the [NetBox documentation](https://netboxlabs.com/docs/netbox/en/stable/configuration/plugins/):

> Plugins extend NetBox by allowing external code to run with the same access and privileges as NetBox itself. Only install plugins from trusted sources. The NetBox maintainers make absolutely no guarantees about the integrity or security of your installation with plugins enabled.

## <a name="Logstash"></a>Logstash Output Pipelines

Users may follow these steps to add additional [Logstash output plugins](https://www.elastic.co/docs/reference/logstash/plugins/output-plugins) to which Malcolm's Logstash enrichment pipeline will forward logs after parsing and enrichment.

For example, this method may be used to forward Malcolm's logs to a generic [HTTP/HTTPS endpoint](https://www.elastic.co/docs/reference/logstash/plugins/plugins-outputs-http) (such as Splunk's [HTTP Event Collector](https://docs.splunk.com/Documentation/Splunk/latest/Data/UsetheHTTPEventCollector), HEC), a [Kafka topic](https://www.elastic.co/docs/reference/logstash/plugins/plugins-outputs-kafka), a [syslog server](https://www.elastic.co/docs/reference/logstash/plugins/plugins-outputs-syslog), a [websocket](https://www.elastic.co/docs/reference/logstash/plugins/plugins-outputs-websocket), a [TCP](https://www.elastic.co/docs/reference/logstash/plugins/plugins-outputs-tcp) or [UDP](https://www.elastic.co/docs/reference/logstash/plugins/plugins-outputs-udp) socket, or any number of other Logstash output plugins.

1. In the Malcolm installation directory, create a new subdirectory named `./logstash/pipelines/my-pipeline-id`, replacing `my-pipeline-id` (used for the remainder of this example) with the name of the new pipeline. This directory name should only include alphanumeric characters, hyphens (`-`), and underscores (`_`).
2. As a template/starting point, copy [these `.conf` files]({{ site.github.repository_url }}/tree/{{ site.github.build_revision }}/logstash/pipelines/external) into the new pipeline directory. Users may wish to rename the files `01_input_external_os.conf` and `99_opensearch_output.conf` to reflect the name of the new pipeline (e.g., `01_input_my-pipeline-id.conf` and `99_my-pipeline-id_output.conf`, respectively), but the filenames themselves don't really matter. However, the files should retain the sort order indicated by their `01_` and `99_` prefixes.
3. Replace the input pipeline address name inside quotation marks the `01_`-prefixed file with the name of your pipeline (e.g., `my-pipeline-id`).
4. Completely replace the contents of the `output` filter in the `99_`-prefixed file with the [output filter configuraiton](https://www.elastic.co/docs/reference/logstash/plugins/output-plugins) which Malcolm will use to forward the enriched logs.
5. The contents of `00_config.conf` are for if the new output pipeline needs to be configured as a [persistent queue](https://www.elastic.co/docs/reference/logstash/persistent-queues), which helps protect against data loss during abnormal termination by storing the in-flight message queue to disk. Users who don't need persistent queuing for this output pipeline or who are unsure may delete `00_config.conf` from the new pipeline directory.
6. Edit [`docker-compose.yml`]({{ site.github.repository_url }}/blob/{{ site.github.build_revision }}/docker-compose.yml) in the Malcolm installation directory.
    * Add the following to `volumes` section under the `logstash` service, following the indentation and formatting of the other items in that section:

    ```
    - type: bind
      bind:
        create_host_path: false
      source: ./logstash/pipelines/my-pipeline-id
      target: /usr/share/logstash/malcolm-pipelines.available/my-pipeline-id
      read_only: true
    ```

7. Define a new [environment variable](malcolm-config.md#MalcolmConfigEnvVars) in [`./config/logstash.env`]({{ site.github.repository_url }}/blob/{{ site.github.build_revision }}/config/logstash.env.example) named `LOGSTASH_OPENSEARCH_OUTPUT_PIPELINE_ADDRESSES` with the value `internal-os,external-os,my-pipeline-id`.
8. [Restart Malcolm](running.md#StopAndRestart).



## <a name="Other"></a>Other Customizations

There are other areas of Malcolm that can be modified and customized to fit users' needs. Please see these other sections of the documentation for more information.

* [Building your own visualizations and dashboards](dashboards.md#BuildDashboard)
* [Customizing event severity scoring](severity.md#SeverityConfig)
* [Zeek Intelligence Framework](zeek-intel.md#ZeekIntel)
* Populating the NetBox inventory [Manually](asset-interaction-analysis.md#NetBoxPopManual) or through [Preloading](asset-interaction-analysis.md#NetBoxPreload)
* [Modifying or Contributing to Malcolm](contributing-guide.md)
